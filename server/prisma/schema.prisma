// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "tenant"]
}

// ============================================
// PLATFORM-LEVEL MODELS (public schema)
// ============================================

model PHC {
  id              String    @id @default(uuid())
  name            String
  address         String
  contactNumber   String
  licenseNumber   String    @unique
  adminEmail      String
  status          PHCStatus @default(PENDING)
  schemaName      String    @unique // e.g., "phc_abc123"
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("phc")
  @@schema("public")
}

enum PHCStatus {
  PENDING
  VERIFIED
  ACTIVE
  SUSPENDED
  INACTIVE
  
  @@schema("public")
}

model SuperAdmin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("super_admin")
  @@schema("public")
}

model PlatformAuditLog {
  id        String   @id @default(uuid())
  action    String
  actorId   String
  actorType String   // SUPER_ADMIN, SYSTEM
  details   String
  createdAt DateTime @default(now())
  
  @@map("platform_audit_log")
  @@schema("public")
}

// ============================================
// TENANT-LEVEL MODELS (per-PHC schema)
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   // ADMIN, DOCTOR, NURSE, LAB_TECH, PHARMACIST
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@schema("tenant")
}

model Patient {
  id        String   @id @default(uuid())
  name      String
  age       Int
  gender    String
  phone     String
  address   String?
  bloodGroup String?
  emergencyContact String?
  
  // Vitals (captured at registration)
  weight    Float?
  bp        String?
  sugar     String?
  temp      Float?
  
  // Medical Background
  preExistingDiseases String? // Comma-separated or JSON
  allergies           String? // Comma-separated or JSON
  isPregnant          Boolean @default(false)
  patientType         String  @default("OPD") // OPD, ADMITTED, REFERRED
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  opdVisits OPDVisit[]
  admissions Admission[]
  
  @@schema("tenant")
}

model OPDVisit {
  id        String   @id @default(uuid())
  patientId String
  patient   Patient  @relation(fields: [patientId], references: [id])
  tokenNo   Int
  status    String   // WAITING, IN_CONSULTATION, COMPLETED
  
  // Vitals
  weight    Float?
  bp        String?
  sugar     String?
  temp      Float?
  
  symptoms  String?
  diagnosis String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  prescriptions Prescription[]
  labOrders     LabOrder[]
  
  @@schema("tenant")
}

model LabOrder {
  id        String   @id @default(uuid())
  opdVisitId String
  opdVisit  OPDVisit @relation(fields: [opdVisitId], references: [id])
  testName  String
  status    String   // PENDING, COMPLETED
  result    String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@schema("tenant")
}

model Prescription {
  id        String   @id @default(uuid())
  opdVisitId String
  opdVisit  OPDVisit @relation(fields: [opdVisitId], references: [id])
  medicine  String
  dosage    String
  status    String   // PENDING, DISPENSED
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@schema("tenant")
}

model Bed {
  id        String   @id @default(uuid())
  number    String   @unique
  isOccupied Boolean @default(false)
  
  admissions Admission[]
  
  @@schema("tenant")
}

model Admission {
  id        String   @id @default(uuid())
  patientId String
  patient   Patient  @relation(fields: [patientId], references: [id])
  bedId     String
  bed       Bed      @relation(fields: [bedId], references: [id])
  
  admittedAt DateTime @default(now())
  dischargedAt DateTime?
  status    String   // ADMITTED, DISCHARGED
  
  @@schema("tenant")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  actorId   String
  details   String
  createdAt DateTime @default(now())
  
  @@schema("tenant")
}
